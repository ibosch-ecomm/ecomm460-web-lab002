---
import { getPageBySlug } from '../lib/graphql';
import { cleanDiviShortcodes } from '../utils/cleanDivi';
import ContentLayout from '../layouts/ContentLayout.astro';

const { slug } = Astro.params;

let page = null;
let error = null;

try {
  const data = await getPageBySlug(slug);
  page = data?.page;
  
  if (!page) {
    return Astro.redirect('/404');
  }
} catch (err) {
  console.error('Error fetching page:', err);
  error = err;
  return Astro.redirect('/404');
}

const cleanedContent = cleanDiviShortcodes(page.content);
---

<ContentLayout 
  title={page.title}
  description={page.excerpt}
  image={page.featuredImage?.node?.sourceUrl}
>
  {page.featuredImage && (
    <div class="mb-8">
      <img 
        src={page.featuredImage.node.sourceUrl}
        alt={page.featuredImage.node.altText || page.title}
        class="w-full rounded-2xl shadow-medium"
      />
    </div>
  )}

  <div class="prose prose-lg max-w-none" set:html={cleanedContent} />
</ContentLayout>
